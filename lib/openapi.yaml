openapi: 3.0.3
info:
  title: SPICE SGP4 API
  description: |
    REST API for SGP4 satellite orbit propagation using NASA/JPL NAIF CSPICE compiled to WebAssembly.

    ## Features
    - Parse Two-Line Element (TLE) sets into orbital elements
    - Parse Orbital Mean-Elements Message (OMM) JSON into orbital elements
    - Convert between TLE and OMM formats
    - Propagate satellite state to any epoch
    - Convert between UTC and Ephemeris Time
    - Support for WGS-72 and WGS-84 geophysical models

    ## Data Formats
    - **TLE**: Legacy Two-Line Element format (69 characters per line)
    - **OMM**: CCSDS Orbital Mean-Elements Message (JSON format, CCSDS 502.0-B-2)

    ## Reference Frames
    All position and velocity outputs are in the TEME (True Equator Mean Equinox) reference frame,
    which is the standard frame for SGP4 propagation.
  version: 1.0.0
  license:
    name: GPL-3.0
    url: https://www.gnu.org/licenses/gpl-3.0.html
  contact:
    name: GitHub Repository
    url: https://github.com/haisamido/spice

servers:
  - url: http://localhost:50000
    description: Local development server

tags:
  - name: SGP4
    description: Satellite propagation endpoints (TLE format)
  - name: OMM
    description: Orbital Mean-Elements Message endpoints (JSON format)
  - name: Time
    description: Time conversion endpoints
  - name: Models
    description: Geophysical model endpoints

paths:
  /api/spice/sgp4/health:
    get:
      summary: Health check
      description: Check if the API server is running and the SGP4 module is initialized.
      tags:
        - SGP4
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                initialized: true

  /api/spice/sgp4/parse:
    post:
      summary: Parse TLE
      description: |
        Parse a Two-Line Element (TLE) set into orbital elements.
        Returns the epoch and 10-element array used by the SGP4 propagator.
      tags:
        - SGP4
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TLEInput'
            example:
              line1: "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025"
              line2: "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19"
      responses:
        '200':
          description: Successfully parsed TLE
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParseResponse'
        '400':
          description: Missing or invalid TLE lines
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/propagate:
    post:
      summary: Propagate TLE or OMM
      description: |
        Unified propagation endpoint supporting both TLE and OMM input formats.

        **Single time mode**: Provide only `t0` to get one state vector at that time.

        **Range mode**: Provide `t0`, `tf`, and `step` to get an array of state vectors
        from t0 to tf at each step interval. Maximum of 10,000 points allowed per request.

        **Input format**: Use `input_type=tle` (default) for TLE input or `input_type=omm` for OMM input.
      tags:
        - SGP4
      parameters:
        - name: t0
          in: query
          required: true
          description: Start time / single time (UTC string, e.g., "2024-01-15T12:00:00")
          schema:
            type: string
        - name: tf
          in: query
          required: false
          description: End time (UTC string). Required for range mode.
          schema:
            type: string
        - name: step
          in: query
          required: false
          description: Time step size. Required for range mode.
          schema:
            type: number
        - name: unit
          in: query
          description: Time step unit (only used in range mode)
          schema:
            type: string
            enum: [sec, min]
            default: sec
        - name: wgs
          in: query
          description: Geophysical model to use
          schema:
            type: string
            enum: [wgs72, wgs84]
            default: wgs72
        - name: input_type
          in: query
          description: Input format type
          schema:
            type: string
            enum: [tle, omm]
            default: tle
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/TLEInput'
                - $ref: '#/components/schemas/OMMPropagateInput'
            examples:
              tle:
                summary: TLE input
                value:
                  line1: "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025"
                  line2: "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19"
              omm:
                summary: OMM input
                value:
                  omm:
                    OBJECT_NAME: "ISS (ZARYA)"
                    OBJECT_ID: "1998-067A"
                    EPOCH: "2024-01-15T12:00:00.000"
                    MEAN_MOTION: 15.49560830
                    ECCENTRICITY: 0.0006703
                    INCLINATION: 51.6400
                    RA_OF_ASC_NODE: 208.9163
                    ARG_OF_PERICENTER: 30.0825
                    MEAN_ANOMALY: 330.0579
                    NORAD_CAT_ID: 25544
                    BSTAR: 0.00010270
                    MEAN_MOTION_DOT: 0.00016717
      responses:
        '200':
          description: Successfully propagated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PropagateRangeResponse'
        '400':
          description: Missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/omm/parse:
    post:
      summary: Parse OMM
      description: |
        Parse an Orbital Mean-Elements Message (OMM) JSON into orbital elements.
        Also returns the equivalent TLE representation.
      tags:
        - OMM
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OMMInput'
            example:
              OBJECT_NAME: "ISS (ZARYA)"
              OBJECT_ID: "1998-067A"
              EPOCH: "2024-01-15T12:00:00.000"
              MEAN_MOTION: 15.49560830
              ECCENTRICITY: 0.0006703
              INCLINATION: 51.6400
              RA_OF_ASC_NODE: 208.9163
              ARG_OF_PERICENTER: 30.0825
              MEAN_ANOMALY: 330.0579
              NORAD_CAT_ID: 25544
              BSTAR: 0.00010270
              MEAN_MOTION_DOT: 0.00016717
      responses:
        '200':
          description: Successfully parsed OMM
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OMMParseResponse'
        '400':
          description: Missing or invalid OMM fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/omm/to-tle:
    post:
      summary: Convert OMM to TLE
      description: Convert an Orbital Mean-Elements Message (OMM) JSON to Two-Line Element format.
      tags:
        - OMM
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OMMInput'
      responses:
        '200':
          description: Successfully converted to TLE
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TLEOutput'
        '400':
          description: Missing or invalid OMM fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/tle/to-omm:
    post:
      summary: Convert TLE to OMM
      description: Convert a Two-Line Element set to Orbital Mean-Elements Message (OMM) JSON format.
      tags:
        - OMM
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TLEInput'
      responses:
        '200':
          description: Successfully converted to OMM
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OMMOutput'
        '400':
          description: Missing or invalid TLE lines
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/time/utc-to-et:
    get:
      summary: Convert UTC to Ephemeris Time
      description: |
        Convert a UTC time string to Ephemeris Time (ET).
        ET is measured in seconds past J2000 TDB (Barycentric Dynamical Time).
      tags:
        - Time
      parameters:
        - name: utc
          in: query
          required: true
          description: UTC time string (e.g., "2024-01-15T12:00:00")
          schema:
            type: string
          example: "2024-01-15T12:00:00"
      responses:
        '200':
          description: Successfully converted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UTCtoETResponse'
        '400':
          description: Missing or invalid UTC parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/spice/sgp4/time/et-to-utc:
    get:
      summary: Convert Ephemeris Time to UTC
      description: |
        Convert Ephemeris Time (ET) to a UTC time string.
        ET is measured in seconds past J2000 TDB.
      tags:
        - Time
      parameters:
        - name: et
          in: query
          required: true
          description: Ephemeris time in seconds past J2000 TDB
          schema:
            type: number
          example: 758894469.184
      responses:
        '200':
          description: Successfully converted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETtoUTCResponse'
        '400':
          description: Missing or invalid ET parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/models/:
    get:
      summary: List available models
      description: Get a list of all available geophysical models.
      tags:
        - Models
      responses:
        '200':
          description: List of models
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelsListResponse'

  /api/models/wgs/{name}:
    get:
      summary: Get model details
      description: Get detailed information about a specific WGS geophysical model.
      tags:
        - Models
      parameters:
        - name: name
          in: path
          required: true
          description: Model name
          schema:
            type: string
            enum: [wgs72, wgs84]
          example: wgs72
      responses:
        '200':
          description: Model details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeophysicalModel'
        '404':
          description: Model not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    TLEInput:
      type: object
      required:
        - line1
        - line2
      properties:
        line1:
          type: string
          description: TLE line 1 (69 characters)
        line2:
          type: string
          description: TLE line 2 (69 characters)

    PropagateInput:
      type: object
      required:
        - line1
        - line2
      properties:
        line1:
          type: string
          description: TLE line 1 (69 characters)
        line2:
          type: string
          description: TLE line 2 (69 characters)
        time:
          oneOf:
            - type: string
              description: UTC time string
            - type: number
              description: Ephemeris time or minutes from epoch
        minutes_from_epoch:
          type: boolean
          description: If true, treat numeric time as minutes from TLE epoch
          default: false
        model:
          type: string
          description: Geophysical model (wgs72 or wgs84)
          enum: [wgs72, wgs84]

    Position:
      type: object
      properties:
        x:
          type: number
          description: X coordinate (km)
        y:
          type: number
          description: Y coordinate (km)
        z:
          type: number
          description: Z coordinate (km)

    Velocity:
      type: object
      properties:
        vx:
          type: number
          description: X velocity (km/s)
        vy:
          type: number
          description: Y velocity (km/s)
        vz:
          type: number
          description: Z velocity (km/s)

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
        initialized:
          type: boolean

    ParseResponse:
      type: object
      properties:
        epoch:
          type: number
          description: Epoch as ephemeris time (seconds past J2000 TDB)
        elements:
          type: array
          items:
            type: number
          description: 10-element orbital elements array

    PropagateResponse:
      type: object
      properties:
        position:
          $ref: '#/components/schemas/Position'
        velocity:
          $ref: '#/components/schemas/Velocity'
        epoch:
          type: number
          description: TLE epoch (seconds past J2000 TDB)
        model:
          type: string
          description: Geophysical model used

    PropagateRangeResponse:
      type: object
      properties:
        states:
          type: array
          items:
            type: object
            properties:
              time:
                type: string
                description: UTC time string
              et:
                type: number
                description: Ephemeris time (seconds past J2000 TDB)
              position:
                $ref: '#/components/schemas/Position'
              velocity:
                $ref: '#/components/schemas/Velocity'
        epoch:
          type: number
          description: TLE epoch (seconds past J2000 TDB)
        model:
          type: string
          description: Geophysical model used
        count:
          type: integer
          description: Number of state vectors returned
        t0:
          type: string
          description: Start time
        tf:
          type: string
          description: End time
        step:
          type: number
          description: Time step
        unit:
          type: string
          description: Time step unit (sec or min)

    UTCtoETResponse:
      type: object
      properties:
        et:
          type: number
          description: Ephemeris time (seconds past J2000 TDB)

    ETtoUTCResponse:
      type: object
      properties:
        utc:
          type: string
          description: UTC time string

    ModelsListResponse:
      type: object
      properties:
        models:
          type: array
          items:
            type: string
        default:
          type: string

    GeophysicalConstants:
      type: object
      properties:
        J2:
          type: number
          description: J2 gravitational harmonic
        J3:
          type: number
          description: J3 gravitational harmonic
        J4:
          type: number
          description: J4 gravitational harmonic
        KE:
          type: number
          description: sqrt(GM) in earth-radii^(3/2) / minute
        QO:
          type: number
          description: Atmospheric model parameter (km)
        SO:
          type: number
          description: Atmospheric model parameter (km)
        RE:
          type: number
          description: Earth equatorial radius (km)
        AE:
          type: number
          description: Distance units per Earth radius

    GeophysicalModel:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        source:
          type: string
        constants:
          $ref: '#/components/schemas/GeophysicalConstants'
        units:
          type: object
          additionalProperties:
            type: string

    OMMInput:
      type: object
      required:
        - OBJECT_NAME
        - OBJECT_ID
        - EPOCH
        - MEAN_MOTION
        - ECCENTRICITY
        - INCLINATION
        - RA_OF_ASC_NODE
        - ARG_OF_PERICENTER
        - MEAN_ANOMALY
        - NORAD_CAT_ID
        - BSTAR
        - MEAN_MOTION_DOT
      properties:
        CCSDS_OMM_VERS:
          type: string
          description: OMM version (default "2.0")
        CREATION_DATE:
          type: string
          description: Creation timestamp
        ORIGINATOR:
          type: string
          description: Data originator
        OBJECT_NAME:
          type: string
          description: Satellite name
        OBJECT_ID:
          type: string
          description: International designator (e.g., "1998-067A")
        CENTER_NAME:
          type: string
          description: Central body (default "EARTH")
        REF_FRAME:
          type: string
          description: Reference frame (default "TEME")
        TIME_SYSTEM:
          type: string
          description: Time system (default "UTC")
        MEAN_ELEMENT_THEORY:
          type: string
          description: Propagation theory (default "SGP4")
        EPOCH:
          type: string
          description: Epoch timestamp (ISO 8601)
        MEAN_MOTION:
          type: number
          description: Mean motion (revolutions/day)
        ECCENTRICITY:
          type: number
          description: Orbital eccentricity
        INCLINATION:
          type: number
          description: Inclination (degrees)
        RA_OF_ASC_NODE:
          type: number
          description: Right ascension of ascending node (degrees)
        ARG_OF_PERICENTER:
          type: number
          description: Argument of pericenter (degrees)
        MEAN_ANOMALY:
          type: number
          description: Mean anomaly (degrees)
        EPHEMERIS_TYPE:
          type: integer
          description: Ephemeris type (default 0 for SGP4)
        CLASSIFICATION_TYPE:
          type: string
          description: Classification (U=Unclassified, C=Classified, S=Secret)
        NORAD_CAT_ID:
          type: integer
          description: NORAD catalog number
        ELEMENT_SET_NO:
          type: integer
          description: Element set number
        REV_AT_EPOCH:
          type: integer
          description: Revolution number at epoch
        BSTAR:
          type: number
          description: Drag coefficient (1/Earth radii)
        MEAN_MOTION_DOT:
          type: number
          description: First derivative of mean motion (rev/day^2)
        MEAN_MOTION_DDOT:
          type: number
          description: Second derivative of mean motion (rev/day^3)

    OMMPropagateInput:
      type: object
      required:
        - omm
      properties:
        omm:
          $ref: '#/components/schemas/OMMInput'

    OMMParseResponse:
      type: object
      properties:
        epoch:
          type: number
          description: Epoch as ephemeris time (seconds past J2000 TDB)
        elements:
          type: array
          items:
            type: number
          description: 10-element orbital elements array
        tle:
          type: object
          properties:
            line1:
              type: string
            line2:
              type: string

    OMMOutput:
      $ref: '#/components/schemas/OMMInput'

    TLEOutput:
      type: object
      properties:
        line1:
          type: string
          description: TLE line 1 (69 characters)
        line2:
          type: string
          description: TLE line 2 (69 characters)
        name:
          type: string
          description: Satellite name (optional)

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
