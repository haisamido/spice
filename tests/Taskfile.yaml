# API Test Tasks for SPICE
# https://taskfile.dev
#
# These tasks are included by the root Taskfile.yaml
# Invoke with: task test:api:health, task test:api:all, etc.

version: '3'

vars:
  API_HOST: '{{.API_HOST | default "localhost"}}'
  SERVICE_HOST_PORT: '{{.SERVICE_HOST_PORT | default "50000"}}'
  API_BASE: 'http://{{.API_HOST}}:{{.SERVICE_HOST_PORT}}/api/spice/sgp4'
  MODELS_BASE: 'http://{{.API_HOST}}:{{.SERVICE_HOST_PORT}}/api/models'

  # ISS TLE test data (epoch: 2024-01-15)
  TLE_BODY: |
    {
      "line1": "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025",
      "line2": "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19"
    }

  # ISS OMM test data (equivalent to TLE above)
  OMM_BODY: |
    {
      "OBJECT_NAME": "ISS (ZARYA)",
      "OBJECT_ID": "1998-067A",
      "EPOCH": "2024-01-15T12:00:00.000",
      "MEAN_MOTION": 15.49560830,
      "ECCENTRICITY": 0.0006703,
      "INCLINATION": 51.6400,
      "RA_OF_ASC_NODE": 208.9163,
      "ARG_OF_PERICENTER": 30.0825,
      "MEAN_ANOMALY": 330.0579,
      "NORAD_CAT_ID": 25544,
      "BSTAR": 0.00010270,
      "MEAN_MOTION_DOT": 0.00016717
    }

tasks:
  api:health:
    desc: Test health endpoint
    cmds:
      - echo "=== Testing Health Endpoint ==="
      - cmd: curl -s {{.API_BASE}}/health | jq .

  api:parse:tle:
    desc: Test TLE parse endpoint
    cmds:
      - echo "=== Testing TLE Parse Endpoint ==="
      - cmd: curl -s -X POST {{.API_BASE}}/parse -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .

  api:propagate:tle:t0:
    desc: Test TLE propagate (single time, t0 only, default txt output)
    cmds:
      - echo "=== Testing TLE Propagate (t0 only, default txt) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:tle:t0:txt:
    desc: Test TLE propagate (single time, txt output)
    cmds:
      - echo "=== Testing TLE Propagate (t0, txt output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&output_type=txt" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:tle:t0:json:
    desc: Test TLE propagate (single time, json output)
    cmds:
      - echo "=== Testing TLE Propagate (t0, json output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&output_type=json" -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .

  api:propagate:tle:t0:tf:
    desc: Test TLE propagate (time range, t0 to tf, default txt output)
    cmds:
      - echo "=== Testing TLE Propagate (t0 to tf, 60-sec step, default txt) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:tle:t0:tf:txt:
    desc: Test TLE propagate (time range, txt output)
    cmds:
      - echo "=== Testing TLE Propagate (t0 to tf, txt output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&output_type=txt" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:tle:t0:tf:json:
    desc: Test TLE propagate (time range, json output)
    cmds:
      - echo "=== Testing TLE Propagate (t0 to tf, json output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&output_type=json" -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .

  api:utc-to-et:
    desc: Test UTC to ET conversion endpoint
    cmds:
      - echo "=== Testing UTC to ET Conversion ==="
      - cmd: curl -s "{{.API_BASE}}/time/utc-to-et?utc=2024-01-15T12:00:00" | jq .

  api:et-to-utc:
    desc: Test ET to UTC conversion endpoint
    cmds:
      - echo "=== Testing ET to UTC Conversion ==="
      - cmd: curl -s "{{.API_BASE}}/time/et-to-utc?et=758894469.184" | jq .

  api:models:
    desc: Test models list endpoint
    cmds:
      - echo "=== Testing Models List ==="
      - cmd: curl -s {{.MODELS_BASE}}/ | jq .

  api:models:wgs72:
    desc: Test WGS-72 model details
    cmds:
      - echo "=== Testing WGS-72 Model ==="
      - cmd: curl -s {{.MODELS_BASE}}/wgs/wgs72 | jq .

  api:models:wgs84:
    desc: Test WGS-84 model details
    cmds:
      - echo "=== Testing WGS-84 Model ==="
      - cmd: curl -s {{.MODELS_BASE}}/wgs/wgs84 | jq .

  api:propagate:wgs84:
    desc: Test propagate with WGS-84 model (default txt output)
    cmds:
      - echo "=== Testing Propagate with WGS-84 (default txt) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&wgs=wgs84" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:body-param:
    desc: Test propagate with body as query parameter (GET request, 1 day, 60-sec step, txt output)
    cmds:
      - echo "=== Testing Propagate with body query parameter (GET, 1 day, 60-sec step, txt) ==="
      - cmd: curl -s -G "{{.API_BASE}}/propagate" --data-urlencode "t0=2024-01-15T12:00:00" --data-urlencode "tf=2024-01-16T12:00:00" --data-urlencode "step=60" --data-urlencode "unit=sec" --data-urlencode "output_type=txt" --data-urlencode 'body={{.TLE_BODY}}'
      - echo ""
      - echo "Browser-pasteable URL (copy entire line):"
      - echo "http://{{.API_HOST}}:{{.SERVICE_HOST_PORT}}/api/spice/sgp4/propagate?t0=2024-01-15T12:00:00&tf=2024-01-16T12:00:00&step=60&unit=sec&output_type=txt&body=%7B%22line1%22%3A%221%2025544U%2098067A%20%20%2024015.50000000%20%20.00016717%20%2000000-0%20%2010270-3%200%20%209025%22%2C%22line2%22%3A%222%2025544%20%2051.6400%20208.9163%200006703%20%2030.0825%20330.0579%2015.49560830%20%20%20%2019%22%7D"

  api:propagate:tle:t0:tf:txt:parallel:
    desc: Run propagate POST in parallel (RUNS=total requests, PARALLEL=concurrency)
    vars:
      RUNS: '{{.RUNS | default "10"}}'
      PARALLEL: '{{.PARALLEL | default "100"}}'
      # Compact TLE JSON for POST body (no newlines)
      TLE_JSON: '{"line1":"1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025","line2":"2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19"}'
    cmds:
      - echo "=== Running {{.RUNS}} requests ({{.PARALLEL}} concurrent) ==="
      - cmd: |
          # Health check - verify server is responding
          if ! curl -sf --connect-timeout 3 {{.API_BASE}}/health > /dev/null 2>&1; then
            echo "ERROR: Server not responding at {{.API_BASE}}/health"
            echo "Start the server with: task container:start"
            exit 1
          fi
      - cmd: |
          TMPFILE=$(mktemp)

          START_TIME=$(date -u '+%Y-%m-%d %H:%M:%S.%3N+00:00')
          START=$(date +%s.%N)

          seq 1 {{.RUNS}} | xargs -P {{.PARALLEL}} -I {} curl -s --connect-timeout 5 --max-time 60 -o /dev/null -w "%{http_code} %{time_total}\n" -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&output_type=txt" -H "Content-Type:application/json" -d '{{.TLE_JSON}}' >> "$TMPFILE"

          END=$(date +%s.%N)
          STOP_TIME=$(date -u '+%Y-%m-%d %H:%M:%S.%3N+00:00')

          # Calculate response time stats
          WALL_TIME=$(echo "$END - $START" | bc)
          TOTAL=$(wc -l < "$TMPFILE" | tr -d ' ')
          SUCCESS=$(grep -c "^200 " "$TMPFILE" || echo 0)
          FAILED=$((TOTAL - SUCCESS))
          TIMES=$(awk '{print $2}' "$TMPFILE")
          RESP_MIN=$(echo "$TIMES" | sort -n | head -1)
          RESP_MAX=$(echo "$TIMES" | sort -n | tail -1)
          RESP_MEAN=$(echo "$TIMES" | awk '{sum+=$1} END {printf "%.3f", sum/NR}')

          echo ""
          echo "=== Summary ==="
          echo "Start time:      $START_TIME"
          echo "Stop time:       $STOP_TIME"
          echo "Concurrency:     {{.PARALLEL}}"
          echo "Total requests:  $TOTAL"
          echo "Successful:      $SUCCESS (HTTP 200)"
          echo "Failed:          $FAILED"
          echo "Response times:  min=${RESP_MIN}s  mean=${RESP_MEAN}s  max=${RESP_MAX}s"
          echo "Wall time:       ${WALL_TIME}s"
          echo "Throughput:      $(echo "scale=2; $TOTAL / $WALL_TIME" | bc) req/s"

          rm -f "$TMPFILE"
    silent: true

  api:parse:omm:
    desc: Test OMM parse endpoint
    cmds:
      - echo "=== Testing OMM Parse Endpoint ==="
      - cmd: curl -s -X POST {{.API_BASE}}/omm/parse -H "Content-Type:application/json" -d '{{.OMM_BODY}}' | jq .

  api:propagate:omm:t0:tf:
    desc: Test OMM propagate (time range, t0 to tf, default txt output)
    cmds:
      - echo "=== Testing OMM Propagate (t0 to tf, 60-sec step, default txt) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&input_type=omm" -H "Content-Type:application/json" -d '{{.OMM_BODY}}'

  api:propagate:omm:t0:tf:txt:
    desc: Test OMM propagate (time range, txt output)
    cmds:
      - echo "=== Testing OMM Propagate (t0 to tf, txt output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&input_type=omm&output_type=txt" -H "Content-Type:application/json" -d '{{.OMM_BODY}}'

  api:propagate:omm:t0:tf:json:
    desc: Test OMM propagate (time range, json output)
    cmds:
      - echo "=== Testing OMM Propagate (t0 to tf, json output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-15T14:00:00&step=60&unit=sec&input_type=omm&output_type=json" -H "Content-Type:application/json" -d '{{.OMM_BODY}}' | jq .

  api:omm:to-tle:
    desc: Test OMM to TLE conversion
    cmds:
      - echo "=== Testing OMM to TLE Conversion ==="
      - cmd: curl -s -X POST {{.API_BASE}}/omm/to-tle -H "Content-Type:application/json" -d '{{.OMM_BODY}}' | jq .

  api:tle:to-omm:
    desc: Test TLE to OMM conversion
    cmds:
      - echo "=== Testing TLE to OMM Conversion ==="
      - cmd: curl -s -X POST {{.API_BASE}}/tle/to-omm -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .

  api:propagate:tle:1day:1sec:txt:
    desc: Test TLE propagate (1 day, 1-second step, txt output - 86401 points)
    cmds:
      - echo "=== Testing TLE Propagate (1 day, 1-sec step, txt output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-16T12:00:00&step=1&unit=sec&output_type=txt" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:tle:14days:1sec:txt:
    desc: Test TLE propagate (14 days, 1-second step, txt output - 1209601 points)
    cmds:
      - echo "=== Testing TLE Propagate (14 days, 1-sec step, txt output) ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-29T12:00:00&step=1&unit=sec&output_type=txt" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'

  api:propagate:batch-size:
    desc: Test propagate with custom batch_size parameter
    cmds:
      - echo "=== Testing Propagate with batch_size=1209 ==="
      - cmd: curl -s -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&tf=2024-01-22T12:00:00&step=1&unit=sec&output_type=txt&batch_size=1209" -H "Content-Type:application/json" -d '{{.TLE_BODY}}'
    silent: true

  api:ci:
    desc: Run API tests for CI (fails fast on errors, uses -sf flag)
    cmds:
      - echo "=== CI API Tests (API_HOST={{.API_HOST}}) ==="
      # Health check
      - echo "Testing health endpoint..."
      - curl -sf {{.API_BASE}}/health | jq .
      # Parse TLE
      - echo "Testing TLE parse..."
      - curl -sf -X POST {{.API_BASE}}/parse -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .
      # Propagate TLE
      - echo "Testing TLE propagate..."
      - curl -sf -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&output_type=json" -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .
      # Time conversions
      - echo "Testing UTC to ET..."
      - curl -sf "{{.API_BASE}}/time/utc-to-et?utc=2024-01-15T12:00:00" | jq .
      - echo "Testing ET to UTC..."
      - curl -sf "{{.API_BASE}}/time/et-to-utc?et=758894469.184" | jq .
      # Models API
      - echo "Testing models list..."
      - curl -sf {{.MODELS_BASE}}/ | jq .
      - echo "Testing WGS-72 model..."
      - curl -sf {{.MODELS_BASE}}/wgs/wgs72 | jq .
      - echo "Testing WGS-84 model..."
      - curl -sf {{.MODELS_BASE}}/wgs/wgs84 | jq .
      # Propagate with WGS-84
      - echo "Testing propagate with WGS-84..."
      - curl -sf -X POST "{{.API_BASE}}/propagate?t0=2024-01-15T12:00:00&wgs=wgs84&output_type=json" -H "Content-Type:application/json" -d '{{.TLE_BODY}}' | jq .
      - echo "=== All CI tests passed ==="

  api:all:
    desc: Run all API tests (server must be running)
    cmds:
      # Health
      - task: api:health
      # Parse
      - task: api:parse:tle
      - task: api:parse:omm
      # Propagate
      - task: api:propagate:tle:t0
      - task: api:propagate:tle:t0:txt
      - task: api:propagate:tle:t0:json
      - task: api:propagate:tle:t0:tf
      - task: api:propagate:tle:t0:tf:txt
      - task: api:propagate:tle:t0:tf:json
      - task: api:propagate:omm:t0:tf
      - task: api:propagate:omm:t0:tf:txt
      - task: api:propagate:omm:t0:tf:json
      - task: api:propagate:wgs84
      - task: api:propagate:body-param
      - task: api:propagate:batch-size
      # Time Conversions
      - task: api:utc-to-et
      - task: api:et-to-utc
      # Models
      - task: api:models
      - task: api:models:wgs72
      - task: api:models:wgs84
      # Conversions
      - task: api:omm:to-tle
      - task: api:tle:to-omm
