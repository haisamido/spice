name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build sgp4-api

      - name: Run unit tests
        run: docker run --rm sgp4-wasm-builder:latest npm test

      - name: Start server
        run: |
          docker compose up -d
          sleep 5

      - name: Run API tests
        run: |
          # Health check
          curl -sf http://localhost:50000/api/spice/sgp4/health | jq .

          # Parse TLE
          curl -sf -X POST http://localhost:50000/api/spice/sgp4/parse \
            -H "Content-Type: application/json" \
            -d '{
              "line1": "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025",
              "line2": "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19"
            }' | jq .

          # Propagate TLE
          curl -sf -X POST http://localhost:50000/api/spice/sgp4/propagate \
            -H "Content-Type: application/json" \
            -d '{
              "line1": "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025",
              "line2": "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19",
              "time": "2024-01-15T12:00:00"
            }' | jq .

          # Time conversions
          curl -sf "http://localhost:50000/api/spice/sgp4/time/utc-to-et?utc=2024-01-15T12:00:00" | jq .
          curl -sf "http://localhost:50000/api/spice/sgp4/time/et-to-utc?et=758894469.184" | jq .

          # Models API
          curl -sf http://localhost:50000/api/models/ | jq .
          curl -sf http://localhost:50000/api/models/wgs/wgs72 | jq .
          curl -sf http://localhost:50000/api/models/wgs/wgs84 | jq .

          # Propagate with WGS-84
          curl -sf -X POST "http://localhost:50000/api/spice/sgp4/propagate?model=wgs84" \
            -H "Content-Type: application/json" \
            -d '{
              "line1": "1 25544U 98067A   24015.50000000  .00016717  00000-0  10270-3 0  9025",
              "line2": "2 25544  51.6400 208.9163 0006703  30.0825 330.0579 15.49560830    19",
              "time": "2024-01-15T12:00:00"
            }' | jq .

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Stop server
        if: always()
        run: docker compose down -v
